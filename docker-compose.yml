# =========================
# Configuration de base commune à dev et prod
# =========================

services:
    # =========================
    # Base de données PostgreSQL
    # =========================
    db:
        image: postgres:16
        container_name: app_db
        # Au final : DATABASE_URL: postgres://app:${POSTGRES_PASSWORD}@db:5432/appdb
        environment:
            POSTGRES_USER: app
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: appdb
        volumes:
            - pgdata:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U app -d appdb"]
            interval: 5s
            timeout: 3s
            retries: 20
        networks:
            - appnet

    # =========================
    # API Backend (Bun + Hono)
    # =========================
    api:
        container_name: app_api
        build:
            context: ./backend
            dockerfile: Dockerfile
        depends_on:
            db:
                condition: service_healthy
        environment:
            DATABASE_URL: postgres://app:${POSTGRES_PASSWORD}@db:5432/appdb
        networks:
            - appnet

    # =========================
    # Frontend React (Vite)
    # =========================
    frontend:
        container_name: app_frontend
        build:
            context: ./frontend
            dockerfile: Dockerfile
        depends_on:
            - api
        networks:
            - appnet

    # =========================
    # Reverse Proxy (Nginx)
    # =========================
    nginx:
        image: nginx:1.27-alpine
        container_name: app_nginx
        restart: unless-stopped
        depends_on:
            - api
            - frontend
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./nginx/conf.d:/etc/nginx/conf.d:ro
            - certbot_data:/etc/letsencrypt
            - certbot_www:/var/www/certbot
        networks:
            - appnet

    # =========================
    # Certbot (Let's Encrypt)
    # =========================
    certbot:
        image: certbot/certbot
        container_name: app_certbot
        restart: unless-stopped
        volumes:
            - certbot_data:/etc/letsencrypt
            - certbot_www:/var/www/certbot
        entrypoint: /bin/sh
        command: >
            -c "trap exit TERM;
                while :;
                do
                  certbot renew;
                  sleep 12h & wait $${!};
                done;"
        networks:
            - appnet

# =========================
# Volumes persistants
# =========================
volumes:
    pgdata:
    certbot_data:
    certbot_www:

# =========================
# Réseau Docker privé
# =========================
networks:
    appnet:
        driver: bridge
